<!DOCTYPE html>

<html>
<head>
  <title>runner.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Readme.html">
                Readme.md
              </a>
            
              
              <a class="source" href="client.html">
                client.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="local.html">
                local.js
              </a>
            
              
              <a class="source" href="progress.html">
                progress.js
              </a>
            
              
              <a class="source" href="runner.html">
                runner.js
              </a>
            
              
              <a class="source" href="screenshot.html">
                screenshot.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>runner.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="keyword">var</span> async = require(<span class="string">'async'</span>)
  , _ = require(<span class="string">'underscore'</span>)

  , spawn = require(<span class="string">'child_process'</span>).spawn
  , path = require(<span class="string">'path'</span>)

  , utils = require(<span class="string">'./utils'</span>)
  , Progress = require(<span class="string">'./progress'</span>);

module.exports = Runner;

<span class="function"><span class="keyword">function</span> <span class="title">Runner</span><span class="params">(options)</span> {</span>
  <span class="keyword">this</span>.options = _.extend({
    environment: <span class="string">'local'</span>,
    config: <span class="string">'./selenium.json'</span>,
    parallel: <span class="literal">false</span>
  }, options);
  <span class="keyword">this</span>.cwd = process.cwd();
  <span class="keyword">var</span> cfile = path.join(<span class="keyword">this</span>.cwd, <span class="keyword">this</span>.options.config);
  <span class="keyword">try</span> {
    <span class="keyword">this</span>.config = require(cfile);
  } <span class="keyword">catch</span> (e) {
    console.error(<span class="string">'Failed to load config file.'</span>);
    <span class="keyword">throw</span> e;
  }
  <span class="keyword">if</span> (!<span class="keyword">this</span>.config || !<span class="keyword">this</span>.config.envs) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Invalid config file. Need `envs: { ... }` defined'</span>);
  }
  <span class="keyword">this</span>.env = <span class="keyword">this</span>.config.envs[<span class="keyword">this</span>.options.environment];
  <span class="keyword">if</span> (!<span class="keyword">this</span>.env) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Requested environmnet not found'</span>);
  }
  <span class="keyword">if</span> (Array.isArray(<span class="keyword">this</span>.env)) {
    <span class="keyword">this</span>.env = {browsers: <span class="keyword">this</span>.env};
  }
  <span class="keyword">this</span>.env.browsers = utils.extendEnv(<span class="keyword">this</span>.config.envs, <span class="keyword">this</span>.env);
}

Runner.prototype = {
  execute: <span class="function"><span class="keyword">function</span> <span class="params">(done)</span> {</span>
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    utils.resolveFiles(<span class="keyword">this</span>.config.files, <span class="keyword">this</span>.cwd, <span class="function"><span class="keyword">function</span> <span class="params">(err, files)</span> {</span>
      <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);
      <span class="keyword">if</span> (!files.length) {
        console.log(<span class="string">'Failed to collect any files to test.'</span>, files, self.config.files);
        <span class="keyword">return</span> done();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>console.log(&#39;Files&#39;, files);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.run(self.options.parallel, files, done);
    });
  },
  run: <span class="function"><span class="keyword">function</span> <span class="params">(parallel, files, done)</span> {</span>
    <span class="keyword">var</span> tasks = []
      , self = <span class="keyword">this</span>
      , progress = <span class="keyword">new</span> Progress(files.length * <span class="keyword">this</span>.env.browsers.length, {update: <span class="number">200</span>});</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>output to start things off</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    console.log(<span class="string">'Running tests in '</span> + (parallel ? <span class="string">'parallel'</span> : <span class="string">'serial'</span>));
    console.log(<span class="string">''</span>);
    utils.printBrowsers(<span class="keyword">this</span>.env.browsers);
    console.log(<span class="string">''</span>);
    utils.printFiles(files);
    console.log(<span class="string">''</span>);

    <span class="keyword">this</span>.env.browsers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(browser)</span> {</span>
      files.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(file)</span> {</span>
        tasks.push(<span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
          <span class="keyword">if</span> (parallel) {
            console.log(<span class="string">'Starting %s on %s'</span>, file, utils.browserName(browser));
          }
          self.runOne(!parallel, file, browser, <span class="function"><span class="keyword">function</span> <span class="params">(code, out)</span> {</span>
            <span class="keyword">if</span> (parallel) {
              console.log();
              process.stdout.write(<span class="string">'\n  '</span> + utils.recolor(out, code));
            }
            progress.inc(!code);
            next(<span class="literal">null</span>, code);
          });
        });
      });
    });
    async[parallel ? <span class="string">'parallel'</span> : <span class="string">'series'</span>](tasks, <span class="function"><span class="keyword">function</span> <span class="params">(err, results)</span> {</span>
      progress.terminate();
      <span class="keyword">if</span> (!results.length) {
        console.log(<span class="string">'Looks like no files were run. Check your configuration?'</span>);
        <span class="keyword">return</span> done(<span class="number">1</span>);
      }
      <span class="keyword">var</span> passed = <span class="number">0</span>
        , failed = <span class="number">0</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;results.length; i++) {
        <span class="keyword">if</span> (results[i]) failed++;
        <span class="keyword">else</span> passed++;
      }
      console.log(<span class="string">'  '</span> + utils.color(passed + <span class="string">' passed'</span>, <span class="number">32</span>));
      <span class="keyword">if</span> (failed) {
        console.log(<span class="string">'  '</span> + utils.color(failed + <span class="string">' failed'</span>, <span class="number">31</span>));
      }
      done(failed, passed);
    });
  },
  runOne: <span class="function"><span class="keyword">function</span> <span class="params">(pipe, file, browser, done)</span> {</span>
    <span class="keyword">var</span> auth = _.extend({}, <span class="keyword">this</span>.env.auth);
    <span class="keyword">if</span> (auth &amp;&amp; auth.type === <span class="string">'env'</span>) {
      auth.username = process.env[auth.username];
      auth.password = process.env[auth.password];
    }
    <span class="keyword">var</span> out = <span class="string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>console.log(&#39;Running&#39;, files, pipe, browser);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ENV = _.extend({}, process.env, {
      SEL_USERNAME: auth &amp;&amp; auth.username,
      SEL_PASSWORD: auth &amp;&amp; auth.password,
      SEL_BROWSER: browser[<span class="number">0</span>],
      SEL_VERSION: browser[<span class="number">1</span>],
      SEL_PLATFORM: browser[<span class="number">2</span>]
    });
    <span class="keyword">if</span> (<span class="keyword">this</span>.env.hostname) {
      ENV.SEL_HOST = <span class="keyword">this</span>.env.hostname;
      ENV.SEL_PORT = <span class="keyword">this</span>.env.port;
    }
    <span class="keyword">var</span> child = spawn(<span class="string">'/usr/bin/env'</span>, [<span class="string">'mocha'</span>, <span class="string">'-R'</span>, <span class="string">'spec'</span>, file], {
      stdio: pipe ? <span class="string">'inherit'</span> : <span class="literal">undefined</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>detached: true,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cwd: <span class="keyword">this</span>.cwd,
      env: ENV
    });
    <span class="keyword">if</span> (!pipe) {
      child.stdout.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
        out += data;
      });
      child.stderr.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
        out += data;
      });
    }
    child.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(code)</span> {</span>
      done(code, out);
    });
  },
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
